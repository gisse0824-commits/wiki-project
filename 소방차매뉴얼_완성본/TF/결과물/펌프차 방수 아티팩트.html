<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œë°©ì°¨ ë¬¼ ê³µê¸‰ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f3f4f6;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        .container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #f3f4f6;
        }
        
        .control-panel-container {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 10;
        }
        
        .toggle-button {
            margin-bottom: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.75rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            transform-origin: center;
        }
        
        .toggle-button:hover {
            transform: scale(1.05);
        }
        
        .toggle-button.active {
            background: linear-gradient(to right, #3b82f6, #9333ea);
            color: white;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        
        .toggle-button.inactive {
            background: linear-gradient(to right, #4b5563, #1f2937);
            color: #d1d5db;
        }
        
        .control-panel {
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(4px);
            padding: 0.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            border: 1px solid #374151;
            display: none;
        }
        
        .control-panel.show {
            display: block;
        }
        
        .panel-title {
            font-size: 0.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: white;
            display: flex;
            align-items: center;
        }
        
        .panel-title .pulse-dot {
            width: 0.25rem;
            height: 0.25rem;
            background: #ef4444;
            border-radius: 50%;
            margin-right: 0.25rem;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .button-item {
            position: relative;
        }
        
        .control-btn {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            transform-origin: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }
        
        .control-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            background: linear-gradient(to right, #9ca3af, #a1a5b4);
            color: #4b5563;
        }
        
        .control-btn.active {
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }
        
        .btn-hydrant.active {
            background: linear-gradient(to right, #10b981, #059669);
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.5);
        }
        
        .btn-hydrant.inactive {
            background: linear-gradient(to right, #4b5563, #1f2937);
            color: #d1d5db;
        }
        
        .btn-main.active {
            background: linear-gradient(to right, #3b82f6, #1e40af);
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
        }
        
        .btn-main.inactive {
            background: linear-gradient(to right, #4b5563, #1f2937);
            color: #d1d5db;
        }
        
        .btn-pto.active {
            background: linear-gradient(to right, #ef4444, #ea580c);
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.5);
        }
        
        .btn-pto.inactive {
            background: linear-gradient(to right, #4b5563, #1f2937);
            color: #d1d5db;
        }
        
        .status-dot {
            width: 0.25rem;
            height: 0.25rem;
            border-radius: 50%;
            margin-right: 0.25rem;
        }
        
        .status-dot.off {
            background: #9ca3af;
        }
        
        .status-dot.on {
            background: white;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .btn-label {
            display: flex;
            align-items: center;
        }
        
        .btn-description {
            font-size: 9px;
            color: #9ca3af;
            margin-top: 0.125rem;
            margin-left: 0.25rem;
            display: flex;
            align-items: center;
        }
        
        .btn-description span {
            margin-right: 0.125rem;
        }
        
        .instructions-container {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            z-index: 10;
        }
        
        .instructions-panel {
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(4px);
            padding: 0.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            border: 1px solid #374151;
            max-width: 20rem;
            display: none;
        }
        
        .instructions-panel.show {
            display: block;
        }
        
        .instructions-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
        }
        
        .instructions-title .pulse-dot {
            width: 0.25rem;
            height: 0.25rem;
            background: #facc15;
            border-radius: 50%;
            margin-right: 0.25rem;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .instructions-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
            font-size: 9px;
        }
        
        .instructions-list li {
            display: flex;
            align-items: flex-start;
            color: #d1d5db;
        }
        
        .instructions-list span:first-child {
            margin-right: 0.125rem;
            margin-top: 0.125rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <canvas id="canvas"></canvas>
        
        <div class="control-panel-container">
            <button class="toggle-button active" id="togglePanelBtn">ì œì–´íŒ ìˆ¨ê¸°ê¸°</button>
            <div class="control-panel show" id="controlPanel">
                <h2 class="panel-title">
                    <div class="pulse-dot"></div>
                    ì†Œë°©ì°¨ ë¬¼ ê³µê¸‰ ì‹œìŠ¤í…œ
                </h2>
                <div class="button-group">
                    <div class="button-item">
                        <button class="control-btn btn-hydrant inactive" id="hydrantBtn">
                            <div class="btn-label">
                                <div class="status-dot off"></div>
                                ê¸‰ìˆ˜ OFF
                            </div>
                        </button>
                        <p class="btn-description">
                            <span>ğŸš°</span>
                            ì†Œí™”ì „ â†’ ë¬¼íƒ±í¬
                        </p>
                    </div>
                    
                    <div class="button-item">
                        <button class="control-btn btn-main inactive" id="mainValveBtn">
                            <div class="btn-label">
                                <div class="status-dot off"></div>
                                ë©”ì¸ë°¸ë¸Œ OFF
                            </div>
                        </button>
                        <p class="btn-description">
                            <span>ğŸ’§</span>
                            ë¬¼íƒ±í¬ â†’ íŒí”„
                        </p>
                    </div>
                    
                    <div class="button-item">
                        <button class="control-btn btn-pto inactive" id="ptoBtn" disabled>
                            <div class="btn-label">
                                <div class="status-dot off"></div>
                                PTO OFF
                            </div>
                        </button>
                        <p class="btn-description">
                            <span>ğŸ”¥</span>
                            íŒí”„ â†’ ë°©ìˆ˜êµ¬
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions-container">
            <button class="toggle-button active" id="toggleInstructionsBtn">ì‚¬ìš©ë²• ìˆ¨ê¸°ê¸°</button>
            <div class="instructions-panel show" id="instructionsPanel">
                <h3 class="instructions-title">
                    <div class="pulse-dot"></div>
                    ì‚¬ìš©ë²•
                </h3>
                <ul class="instructions-list">
                    <li>
                        <span style="color: #4ade80;">â€¢</span>
                        <span>ì¹´ë©”ë¼ê°€ ìë™ìœ¼ë¡œ 360ë„ íšŒì „í•˜ë©° ì†Œë°©ì°¨ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤</span>
                    </li>
                    <li>
                        <span style="color: #a78bfa;">â€¢</span>
                        <span>ë§ˆìš°ìŠ¤ íœ ë¡œ í™•ëŒ€/ì¶•ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</span>
                    </li>
                    <li>
                        <span style="color: #4ade80;">â€¢</span>
                        <span>ê¸‰ìˆ˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì†Œí™”ì „ì—ì„œ ë¬¼íƒ±í¬ë¡œ ë¬¼ì„ ê³µê¸‰í•˜ì„¸ìš”</span>
                    </li>
                    <li>
                        <span style="color: #60a5fa;">â€¢</span>
                        <span>ë©”ì¸ë°¸ë¸Œë¥¼ ì¼œì„œ ë¬¼íƒ±í¬ì—ì„œ íŒí”„ë¡œ ë¬¼ì„ ê³µê¸‰í•˜ì„¸ìš”</span>
                    </li>
                    <li>
                        <span style="color: #fb923c;">â€¢</span>
                        <span>PTO ë²„íŠ¼ì„ ëˆŒëŸ¬ íŒí”„ì—ì„œ ë°©ìˆ˜êµ¬ë¡œ ë¬¼ì„ ë°©ì‚¬í•˜ì„¸ìš”</span>
                    </li>
                    <li>
                        <span style="color: #22d3ee;">â€¢</span>
                        <span>íˆ¬ëª…í•œ ë°°ê´€ì„ í†µí•´ ë¬¼ì˜ íë¦„ì´ ëª…í™•í•˜ê²Œ ë³´ì…ë‹ˆë‹¤</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // State
        let state = {
            mainValveActive: false,
            ptoActive: false,
            hydrantActive: false
        };

        // Three.js references
        let scene, camera, renderer, canvas;
        let waterParticles = [];
        let pumpParticles = [];
        let sprayParticles = [];
        let hydrantParticles = [];
        let cameraRadius = 18;
        let animationId = null;

        function init() {
            canvas = document.getElementById('canvas');
            
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(12, 8, 15);
            camera.lookAt(0, 2, 0);

            // Renderer
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.alpha = true;

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.camera.near = 0.1;
            directionalLight.shadow.camera.far = 50;
            directionalLight.shadow.camera.left = -10;
            directionalLight.shadow.camera.right = 10;
            directionalLight.shadow.camera.top = 10;
            directionalLight.shadow.camera.bottom = -10;
            scene.add(directionalLight);

            // Ground
            const groundGeometry = new THREE.PlaneGeometry(20, 20);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x90EE90 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Create fire truck structure
            createFireTruck();
            
            // Create particle systems
            createParticleSystems();

            // Setup event listeners
            setupEventListeners();

            // Start animation
            animate();
        }

        function createFireTruck() {
            // Main body
            const bodyGeometry = new THREE.BoxGeometry(12, 2, 3);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0xff0000 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.set(0, 1, 0);
            body.castShadow = true;
            body.receiveShadow = true;
            scene.add(body);

            // Cabin
            const cabinGeometry = new THREE.BoxGeometry(3, 2.5, 3);
            const cabinMaterial = new THREE.MeshLambertMaterial({ color: 0xff0000 });
            const cabin = new THREE.Mesh(cabinGeometry, cabinMaterial);
            cabin.position.set(-5.5, 2.25, 0);
            cabin.castShadow = true;
            cabin.receiveShadow = true;
            scene.add(cabin);

            // Front bumper
            const bumperGeometry = new THREE.BoxGeometry(0.3, 0.8, 3.2);
            const bumperMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            const bumper = new THREE.Mesh(bumperGeometry, bumperMaterial);
            bumper.position.set(-7.1, 0.8, 0);
            bumper.castShadow = true;
            scene.add(bumper);

            // Front grille
            const grilleGeometry = new THREE.BoxGeometry(0.1, 1.2, 2.4);
            const grilleMaterial = new THREE.MeshLambertMaterial({ color: 0x222222 });
            const grille = new THREE.Mesh(grilleGeometry, grilleMaterial);
            grille.position.set(-6.95, 1.8, 0);
            scene.add(grille);

            // Headlights
            const headlightGeometry = new THREE.CylinderGeometry(0.25, 0.25, 0.2, 12);
            const headlightMaterial = new THREE.MeshLambertMaterial({
                color: 0xFFFFE0,
                emissive: 0xFFFFE0,
                emissiveIntensity: 0.3
            });

            const leftHeadlight = new THREE.Mesh(headlightGeometry, headlightMaterial);
            leftHeadlight.position.set(-6.9, 2.2, -0.8);
            leftHeadlight.rotation.z = Math.PI / 2;
            scene.add(leftHeadlight);

            const rightHeadlight = new THREE.Mesh(headlightGeometry, headlightMaterial);
            rightHeadlight.position.set(-6.9, 2.2, 0.8);
            rightHeadlight.rotation.z = Math.PI / 2;
            scene.add(rightHeadlight);

            // Emergency lights bar on top
            const lightBarGeometry = new THREE.BoxGeometry(2.5, 0.3, 0.8);
            const lightBarMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            const lightBar = new THREE.Mesh(lightBarGeometry, lightBarMaterial);
            lightBar.position.set(-5.5, 3.65, 0);
            scene.add(lightBar);

            // Red emergency lights (front)
            const emergencyLightGeometry = new THREE.SphereGeometry(0.15, 8, 8);
            const redLightMaterial = new THREE.MeshLambertMaterial({
                color: 0xFF0000,
                emissive: 0xFF0000,
                emissiveIntensity: 0.4
            });

            const leftEmergencyLight = new THREE.Mesh(emergencyLightGeometry, redLightMaterial);
            leftEmergencyLight.position.set(-6, 3.8, -0.3);
            scene.add(leftEmergencyLight);

            const rightEmergencyLight = new THREE.Mesh(emergencyLightGeometry, redLightMaterial);
            rightEmergencyLight.position.set(-6, 3.8, 0.3);
            scene.add(rightEmergencyLight);

            // Blue emergency lights (front)
            const blueLightMaterial = new THREE.MeshLambertMaterial({
                color: 0x0000FF,
                emissive: 0x0000FF,
                emissiveIntensity: 0.4
            });

            const leftBlueLight = new THREE.Mesh(emergencyLightGeometry, blueLightMaterial);
            leftBlueLight.position.set(-5, 3.8, -0.3);
            scene.add(leftBlueLight);

            const rightBlueLight = new THREE.Mesh(emergencyLightGeometry, blueLightMaterial);
            rightBlueLight.position.set(-5, 3.8, 0.3);
            scene.add(rightBlueLight);

            // Wheels
            createWheels();

            // Water tank
            const tankGeometry = new THREE.CylinderGeometry(1.0, 1.0, 1.6, 16);
            const tankMaterial = new THREE.MeshLambertMaterial({ color: 0x4169E1 });
            const tank = new THREE.Mesh(tankGeometry, tankMaterial);
            tank.position.set(-4, 3.3, 0);
            tank.castShadow = true;
            scene.add(tank);

            // Pump
            const pumpGeometry = new THREE.BoxGeometry(1.5, 1, 1);
            const pumpMaterial = new THREE.MeshLambertMaterial({ color: 0x808080 });
            const pump = new THREE.Mesh(pumpGeometry, pumpMaterial);
            pump.position.set(2, 2.5, 0);
            pump.castShadow = true;
            scene.add(pump);

            // Nozzle
            const nozzleGeometry = new THREE.CylinderGeometry(0.2, 0.3, 0.8, 8);
            const nozzleMaterial = new THREE.MeshLambertMaterial({ color: 0x2F4F4F });
            const nozzle = new THREE.Mesh(nozzleGeometry, nozzleMaterial);
            nozzle.position.set(4.2, 2.5, 1);
            nozzle.rotation.z = Math.PI / 2;
            nozzle.castShadow = true;
            scene.add(nozzle);

            // Rear lights
            const rearLightGeometry = new THREE.CylinderGeometry(0.15, 0.15, 0.1, 8);
            const rearLightMaterial = new THREE.MeshLambertMaterial({
                color: 0xFF0000,
                emissive: 0xFF0000,
                emissiveIntensity: 0.3
            });

            const leftRearLight = new THREE.Mesh(rearLightGeometry, rearLightMaterial);
            leftRearLight.position.set(5.95, 1.5, -1);
            leftRearLight.rotation.z = Math.PI / 2;
            scene.add(leftRearLight);

            const rightRearLight = new THREE.Mesh(rearLightGeometry, rearLightMaterial);
            rightRearLight.position.set(5.95, 1.5, 1);
            rightRearLight.rotation.z = Math.PI / 2;
            scene.add(rightRearLight);

            // Brake lights
            const brakeLightGeometry = new THREE.CylinderGeometry(0.1, 0.1, 0.08, 8);
            const brakeLightMaterial = new THREE.MeshLambertMaterial({
                color: 0xFF4444,
                emissive: 0xFF2222,
                emissiveIntensity: 0.4
            });

            const leftBrakeLight = new THREE.Mesh(brakeLightGeometry, brakeLightMaterial);
            leftBrakeLight.position.set(5.94, 1.8, -0.7);
            leftBrakeLight.rotation.z = Math.PI / 2;
            scene.add(leftBrakeLight);

            const rightBrakeLight = new THREE.Mesh(brakeLightGeometry, brakeLightMaterial);
            rightBrakeLight.position.set(5.94, 1.8, 0.7);
            rightBrakeLight.rotation.z = Math.PI / 2;
            scene.add(rightBrakeLight);

            // Rear license plate
            const rearPlateGeometry = new THREE.BoxGeometry(0.05, 0.3, 1);
            const rearPlateMaterial = new THREE.MeshLambertMaterial({ color: 0xFFFFFF });
            const rearLicensePlate = new THREE.Mesh(rearPlateGeometry, rearPlateMaterial);
            rearLicensePlate.position.set(5.95, 0.8, 0);
            scene.add(rearLicensePlate);

            // Reflector strips
            const reflectorGeometry = new THREE.BoxGeometry(0.02, 0.1, 2.8);
            const reflectorMaterial = new THREE.MeshLambertMaterial({
                color: 0xFFFF00,
                emissive: 0xFFFF00,
                emissiveIntensity: 0.2
            });
            const reflector = new THREE.Mesh(reflectorGeometry, reflectorMaterial);
            reflector.position.set(5.96, 0.5, 0);
            scene.add(reflector);

            // Rear emergency lights
            const rearEmergencyLightGeometry = new THREE.SphereGeometry(0.12, 8, 8);
            const rearRedLightMaterial = new THREE.MeshLambertMaterial({
                color: 0xFF0000,
                emissive: 0xFF0000,
                emissiveIntensity: 0.5
            });

            const rearLeftEmergencyLight = new THREE.Mesh(rearEmergencyLightGeometry, rearRedLightMaterial);
            rearLeftEmergencyLight.position.set(5.9, 2.2, -1.2);
            scene.add(rearLeftEmergencyLight);

            const rearRightEmergencyLight = new THREE.Mesh(rearEmergencyLightGeometry, rearRedLightMaterial);
            rearRightEmergencyLight.position.set(5.9, 2.2, 1.2);
            scene.add(rearRightEmergencyLight);

            // Hydrant
            const hydrantBodyGeometry = new THREE.CylinderGeometry(0.4, 0.5, 1.5, 8);
            const hydrantBodyMaterial = new THREE.MeshLambertMaterial({ color: 0xFF0000 });
            const hydrantBody = new THREE.Mesh(hydrantBodyGeometry, hydrantBodyMaterial);
            hydrantBody.position.set(-4, 0.75, 2.5);
            hydrantBody.castShadow = true;
            scene.add(hydrantBody);

            // Hydrant top
            const hydrantTopGeometry = new THREE.CylinderGeometry(0.3, 0.4, 0.3, 8);
            const hydrantTopMaterial = new THREE.MeshLambertMaterial({ color: 0xCC0000 });
            const hydrantTop = new THREE.Mesh(hydrantTopGeometry, hydrantTopMaterial);
            hydrantTop.position.set(-4, 1.65, 2.5);
            hydrantTop.castShadow = true;
            scene.add(hydrantTop);

            // Pipes (transparent)
            const createPipe = (start, end, radius = 0.1) => {
                const direction = new THREE.Vector3().subVectors(end, start);
                const length = direction.length();
                const pipeGeometry = new THREE.CylinderGeometry(radius, radius, length, 8);
                const pipeMaterial = new THREE.MeshLambertMaterial({
                    color: 0x87CEEB,
                    transparent: true,
                    opacity: 0.3,
                    side: THREE.DoubleSide
                });
                const pipe = new THREE.Mesh(pipeGeometry, pipeMaterial);
                pipe.position.copy(start.clone().add(end).divideScalar(2));
                pipe.lookAt(end);
                pipe.rotateX(Math.PI / 2);
                return pipe;
            };

            // Tank to pump pipe
            scene.add(createPipe(
                new THREE.Vector3(-4, 2.5, 0),
                new THREE.Vector3(2, 2.5, 0),
                0.30
            ));

            // Pump to nozzle pipes
            scene.add(createPipe(
                new THREE.Vector3(2.75, 2.5, 0),
                new THREE.Vector3(3.5, 2.5, 0),
                0.24
            ));

            scene.add(createPipe(
                new THREE.Vector3(3.5, 2.5, 0),
                new THREE.Vector3(3.5, 2.5, 1),
                0.24
            ));

            // Hydrant to tank pipe
            scene.add(createPipe(
                new THREE.Vector3(-4, 2.5, 2.5),
                new THREE.Vector3(-4, 2.5, 0),
                0.12
            ));
        }

        function createWheels() {
            const wheelGeometry = new THREE.CylinderGeometry(0.8, 0.8, 0.4, 16);
            const wheelMaterial = new THREE.MeshLambertMaterial({ color: 0x2F2F2F });

            const positions = [
                [-5.5, 0.8, -1.7],
                [-5.5, 0.8, 1.7],
                [3, 0.8, -1.7],
                [3, 0.8, 1.7]
            ];

            positions.forEach(pos => {
                const wheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
                wheel.position.set(...pos);
                wheel.rotation.x = Math.PI / 2;
                wheel.castShadow = true;
                scene.add(wheel);
            });
        }

        function createWaterParticles(start, end, count = 20, particleSize = 0.05) {
            const particles = [];
            const particleGeometry = new THREE.SphereGeometry(particleSize, 8, 8);
            const particleMaterial = new THREE.MeshLambertMaterial({
                color: 0x00BFFF,
                emissive: 0x002266,
                emissiveIntensity: 0.2
            });

            for (let i = 0; i < count; i++) {
                const particle = new THREE.Mesh(particleGeometry, particleMaterial);
                particle.position.copy(start);
                particle.userData = {
                    start: start.clone(),
                    end: end.clone(),
                    progress: i / count,
                    speed: 0.015
                };
                particles.push(particle);
                scene.add(particle);
            }
            return particles;
        }

        function createSprayParticles(startPos, count = 220) {
            const particles = [];
            const particleGeometry = new THREE.SphereGeometry(0.1, 6, 6);
            const particleMaterial = new THREE.MeshLambertMaterial({
                color: 0x00BFFF,
                emissive: 0x0033FF,
                emissiveIntensity: 0.6,
                transparent: true,
                opacity: 0.98
            });

            for (let i = 0; i < count; i++) {
                const particle = new THREE.Mesh(particleGeometry, particleMaterial);
                particle.position.copy(startPos);

                const angle = (Math.random() - 0.5) * Math.PI / 16;
                const speed = 0.55 + Math.random() * 0.35;
                const velocity = new THREE.Vector3(
                    Math.cos(angle) * speed,
                    Math.sin(angle) * speed * 0.15 + 0.01,
                    (Math.random() - 0.5) * 0.12
                );

                particle.userData = {
                    startPos: startPos.clone(),
                    velocity: velocity,
                    life: 0,
                    maxLife: 50 + Math.random() * 25,
                    gravity: -0.018
                };
                particles.push(particle);
                scene.add(particle);
            }
            return particles;
        }

        function createParticleSystems() {
            // Water flow from hydrant to tank
            hydrantParticles = createWaterParticles(
                new THREE.Vector3(-4, 2.5, 2.5),
                new THREE.Vector3(-4, 2.5, 0),
                20,
                0.08
            );

            // Water flow from tank to pump
            waterParticles = createWaterParticles(
                new THREE.Vector3(-4, 2.5, 0),
                new THREE.Vector3(2, 2.5, 0),
                25,
                0.08
            );

            // Water flow from pump to nozzle
            pumpParticles = [
                ...createWaterParticles(
                    new THREE.Vector3(2.75, 2.5, 0),
                    new THREE.Vector3(3.5, 2.5, 0),
                    12,
                    0.06
                ),
                ...createWaterParticles(
                    new THREE.Vector3(3.5, 2.5, 0),
                    new THREE.Vector3(3.5, 2.5, 1),
                    10,
                    0.06
                )
            ];

            // Water spray from nozzle
            sprayParticles = createSprayParticles(
                new THREE.Vector3(4.6, 2.5, 1),
                220
            );

            // Hide all particles initially
            [...waterParticles, ...pumpParticles, ...sprayParticles, ...hydrantParticles].forEach(p => {
                p.visible = false;
            });
        }

        function updateHydrantButton() {
            const btn = document.getElementById('hydrantBtn');
            const statusDot = btn.querySelector('.status-dot');
            
            if (state.hydrantActive) {
                btn.classList.remove('inactive');
                btn.classList.add('active');
                statusDot.classList.remove('off');
                statusDot.classList.add('on');
                btn.innerHTML = '<div class="btn-label"><div class="status-dot on"></div>ê¸‰ìˆ˜ ON</div>';
            } else {
                btn.classList.remove('active');
                btn.classList.add('inactive');
                statusDot.classList.remove('on');
                statusDot.classList.add('off');
                btn.innerHTML = '<div class="btn-label"><div class="status-dot off"></div>ê¸‰ìˆ˜ OFF</div>';
            }
        }

        function updateMainValveButton() {
            const btn = document.getElementById('mainValveBtn');
            
            if (state.mainValveActive) {
                btn.classList.remove('inactive');
                btn.classList.add('active');
                btn.innerHTML = '<div class="btn-label"><div class="status-dot on"></div>ë©”ì¸ë°¸ë¸Œ ON</div>';
            } else {
                btn.classList.remove('active');
                btn.classList.add('inactive');
                btn.innerHTML = '<div class="btn-label"><div class="status-dot off"></div>ë©”ì¸ë°¸ë¸Œ OFF</div>';
            }
        }

        function updatePTOButton() {
            const btn = document.getElementById('ptoBtn');
            btn.disabled = !state.mainValveActive;

            if (state.ptoActive && state.mainValveActive) {
                btn.classList.remove('inactive');
                btn.classList.add('active');
                btn.innerHTML = '<div class="btn-label"><div class="status-dot on"></div>PTO ON</div>';
            } else {
                btn.classList.remove('active');
                btn.classList.add('inactive');
                btn.innerHTML = '<div class="btn-label"><div class="status-dot off"></div>PTO OFF</div>';
            }
        }

        function handleHydrant() {
            state.hydrantActive = !state.hydrantActive;
            updateHydrantButton();
        }

        function handleMainValve() {
            state.mainValveActive = !state.mainValveActive;
            updateMainValveButton();
            updatePTOButton();
        }

        function handlePTO() {
            if (state.mainValveActive) {
                state.ptoActive = !state.ptoActive;
                updatePTOButton();
            }
        }

        function toggleControlPanel() {
            const panel = document.getElementById('controlPanel');
            const btn = document.getElementById('togglePanelBtn');

            panel.classList.toggle('show');
            btn.textContent = panel.classList.contains('show') ? 'ì œì–´íŒ ìˆ¨ê¸°ê¸°' : 'ì œì–´íŒ ë³´ê¸°';
        }

        function toggleInstructions() {
            const panel = document.getElementById('instructionsPanel');
            const btn = document.getElementById('toggleInstructionsBtn');

            panel.classList.toggle('show');
            btn.textContent = panel.classList.contains('show') ? 'ì‚¬ìš©ë²• ìˆ¨ê¸°ê¸°' : 'ì‚¬ìš©ë²• ë³´ê¸°';
        }

        function setupEventListeners() {
            document.getElementById('hydrantBtn').addEventListener('click', handleHydrant);
            document.getElementById('mainValveBtn').addEventListener('click', handleMainValve);
            document.getElementById('ptoBtn').addEventListener('click', handlePTO);
            document.getElementById('togglePanelBtn').addEventListener('click', toggleControlPanel);
            document.getElementById('toggleInstructionsBtn').addEventListener('click', toggleInstructions);

            window.addEventListener('resize', handleResize);
            canvas.addEventListener('wheel', handleWheel, { passive: false });
        }

        function handleWheel(event) {
            event.preventDefault();
            const zoomSpeed = 0.5;
            const minRadius = 8;
            const maxRadius = 30;

            if (event.deltaY > 0) {
                cameraRadius = Math.min(maxRadius, cameraRadius + zoomSpeed);
            } else {
                cameraRadius = Math.max(minRadius, cameraRadius - zoomSpeed);
            }
        }

        function handleResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            animationId = requestAnimationFrame(animate);

            // Hydrant particles
            if (state.hydrantActive) {
                hydrantParticles.forEach(particle => {
                    particle.visible = true;
                    particle.userData.progress += particle.userData.speed;
                    if (particle.userData.progress > 1) {
                        particle.userData.progress = 0;
                    }
                    particle.position.lerpVectors(
                        particle.userData.start,
                        particle.userData.end,
                        particle.userData.progress
                    );
                });
            } else {
                hydrantParticles.forEach(p => p.visible = false);
            }

            // Water flow particles (main valve)
            if (state.mainValveActive) {
                waterParticles.forEach(particle => {
                    particle.visible = true;
                    particle.userData.progress += particle.userData.speed;
                    if (particle.userData.progress > 1) {
                        particle.userData.progress = 0;
                    }
                    particle.position.lerpVectors(
                        particle.userData.start,
                        particle.userData.end,
                        particle.userData.progress
                    );
                });
            } else {
                waterParticles.forEach(p => p.visible = false);
            }

            // Pump particles (PTO)
            if (state.ptoActive && state.mainValveActive) {
                pumpParticles.forEach(particle => {
                    particle.visible = true;
                    particle.userData.progress += particle.userData.speed;
                    if (particle.userData.progress > 1) {
                        particle.userData.progress = 0;
                    }
                    particle.position.lerpVectors(
                        particle.userData.start,
                        particle.userData.end,
                        particle.userData.progress
                    );
                });
            } else {
                pumpParticles.forEach(p => p.visible = false);
            }

            // Spray particles
            if (state.ptoActive && state.mainValveActive) {
                sprayParticles.forEach(particle => {
                    particle.visible = true;
                    particle.userData.life += 1;
                    particle.userData.velocity.y += particle.userData.gravity;
                    particle.position.add(particle.userData.velocity);

                    const ageRatio = particle.userData.life / particle.userData.maxLife;
                    particle.material.opacity = Math.max(0, 0.8 - ageRatio);

                    if (particle.userData.life >= particle.userData.maxLife || particle.position.y < 0) {
                        particle.position.copy(particle.userData.startPos);

                        const angle = (Math.random() - 0.5) * Math.PI / 16;
                        const speed = 0.55 + Math.random() * 0.35;
                        particle.userData.velocity = new THREE.Vector3(
                            Math.cos(angle) * speed,
                            Math.sin(angle) * speed * 0.15 + 0.01,
                            (Math.random() - 0.5) * 0.12
                        );
                        particle.userData.life = 0;
                        particle.material.opacity = 0.98;
                    }
                });
            } else {
                sprayParticles.forEach(p => p.visible = false);
            }

            // Camera animation
            const time = Date.now() * 0.001;
            camera.position.x = Math.cos(time * 0.3) * cameraRadius;
            camera.position.z = Math.sin(time * 0.3) * cameraRadius;
            camera.position.y = 8 + Math.sin(time * 0.1) * 2;
            camera.lookAt(0, 2, 0);

            renderer.render(scene, camera);
        }

        // Initialize
        init();
    </script>
</body>
</html>
